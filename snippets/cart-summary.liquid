{% stylesheet %}
  .cart-actions {
    display: flex;
    flex-direction: column;
    gap: var(--gap-2xs);
    border-block: 1px solid var(--color-border);
    padding-block: var(--padding-sm);
    margin-block-start: var(--margin-3xs);
  }

  .cart__summary-totals:not(:has(.cart-actions)) {
    margin-block-start: var(--margin-3xs);
    border-block-start: 1px solid var(--color-border);
    padding-block-start: var(--margin-xl);
  }

  .cart__installments {
    color: var(--color-foreground);
  }
{% endstylesheet %}

<div class="cart__summary-totals">
  {% # We need to keep this node in place to allow morphing to work properly # %}
  <div class="cart__original-total-container cart-primary-typography">
    {%- if cart.cart_level_discount_applications.size > 0 -%}
      <span class="cart__summary-item cart__original-total">
        <span class="cart__original-total-label">{{ 'content.cart_subtotal' | t }}</span>
        <span class="cart__original-total-value cart-secondary-typography">
          {{- cart.original_total_price | money -}}
        </span>
      </span>
      <div class="cart__summary-discounts">
        <ul
          class="discounts list-unstyled"
          role="list"
          aria-label="{{ 'content.discounts' | t }}"
        >
          {%- for discount in cart.cart_level_discount_applications -%}
            <li class="cart__summary-item cart__discount">
              <span class="cart__discount-label">
                {{- 'icon-discount.svg' | inline_asset_content -}}
                {{ discount.title | escape }}
              </span>
              <span class="cart__discount-value cart-secondary-typography"
                >-{{ discount.total_allocated_amount | money -}}
              </span>
            </li>
          {%- endfor -%}
        </ul>
      </div>
    {%- endif -%}
  </div>

  {% if settings.show_cart_note %}
    <div class="cart-actions">
      {% render 'cart-note' %}
    </div>
  {% endif %}

  {%- liquid
    if settings.currency_code_enabled_cart_total
      assign total_price = cart.total_price | money_with_currency
    else
      assign total_price = cart.total_price | money
    endif
  -%}

  <div class="cart__total-container">
    <span
      class="cart__summary-item cart__total"
      role="status"
    >
      <span class="cart__total-label cart-primary-typography">{{ 'content.cart_estimated_total' | t }}</span>
      <text-component
        ref="cartTotal"
        value="{{ total_price }}"
        class="cart__total-value cart-secondary-typography"
        {% comment %} Used by payment_terms web component {% endcomment %}
        data-cart-subtotal
      >
        {{ total_price }}
      </text-component>
    </span>
    {% if settings.show_installments %}
      <span class="cart__summary-item cart__installments">
        {% form 'cart', cart %}
          {{ form | payment_terms }}
        {% endform %}
      </span>
    {% endif %}
    <div class="cart__summary-item tax-note cart-primary-typography">
      {% render 'tax-info', has_discounts_enabled: false %}
    </div>
  </div>
</div>

<div class="cart__ctas">
  <!-- Checkbox AGB obbligatorio -->
  <div class="agb-checkbox-wrapper">
    <label class="agb-accept-label">
      <input
        type="checkbox"
        id="agb-checkbox"
        class="agb-checkbox-input"
        onchange="toggleCheckoutButton()"
      >
      <span class="agb-checkbox-text">
        Ich habe die <a href="/policies/terms-of-service" target="_blank">AGB</a>,
        <a href="/policies/privacy-policy" target="_blank">Datenschutzerkl√§rung</a> und
        <a href="/policies/refund-policy" target="_blank">Widerrufsbelehrung</a> gelesen und akzeptiere diese.
      </span>
    </label>
  </div>

  <!-- AGB Expandable Card (opzionale) -->
  <div class="agb-card" id="agb-card">
    <div class="agb-card-header" onclick="toggleAGBCard()">
      <div class="agb-card-title">
        <span class="agb-icon">üìã</span>
        <span>AGB lesen</span>
      </div>
      <span class="agb-toggle-icon" id="agb-toggle-icon">‚ñº</span>
    </div>

    <div class="agb-card-content" id="agb-card-content" style="display: none;">
      <div class="agb-scrollable">
        <h3>Allgemeine Gesch√§ftsbedingungen (AGB) ‚Äì Pflegebox</h3>
        <p class="agb-company-info"><strong>Agentur Pflegeteufel</strong>, Regentenstra√üe 88, 51063 K√∂ln-M√ºlheim</p>

        <div class="agb-section">
          <h4>1. Geltungsbereich</h4>
          <p>Diese Allgemeinen Gesch√§ftsbedingungen (AGB) gelten f√ºr die Lieferung von Pflegehilfsmitteln im Rahmen der sog. ‚ÄûPflegebox" durch die Agentur Pflegeteufel (nachfolgend ‚ÄûAnbieter") an Pflegebed√ºrftige oder deren gesetzliche Vertreter (nachfolgend ‚ÄûKunde"). Abweichende Bedingungen des Kunden werden nicht anerkannt, es sei denn, der Anbieter stimmt ihrer Geltung ausdr√ºcklich schriftlich zu.</p>
        </div>

        <div class="agb-section">
          <h4>2. Vertragsgegenstand</h4>
          <p>(1) Der Anbieter liefert auf Grundlage von ¬ß 40 Abs. 2 SGB XI Pflegehilfsmittel zum Verbrauch (z. B. Einmalhandschuhe, Desinfektionsmittel, Bettschutzeinlagen), die von der Pflegekasse erstattungsf√§hig sind.</p>
          <p>(2) Art und Umfang der Pflegehilfsmittel richten sich nach den gesetzlichen Vorgaben sowie dem genehmigten Antrag bei der Pflegekasse.</p>
          <p>(3) Der monatliche H√∂chstbetrag f√ºr Pflegehilfsmittel zum Verbrauch betr√§gt derzeit <strong>42 Euro</strong> (gem√§√ü ¬ß 40 Abs. 2 SGB XI).</p>
        </div>

        <div class="agb-section">
          <h4>3. Vertragsabschluss</h4>
          <p>(1) Der Vertrag kommt durch die schriftliche Bestellung des Kunden und deren Best√§tigung durch den Anbieter zustande.</p>
          <p>(2) Voraussetzung ist ein g√ºltiger Leistungsanspruch nach ¬ß 40 Abs. 2 SGB XI. Der Kunde erm√§chtigt den Anbieter, die Abrechnung direkt mit der Pflegekasse vorzunehmen.</p>
          <p>(3) Der Kunde kann die Pflegebox auch unabh√§ngig von einem Anspruch gegen√ºber der Pflegekasse im Rahmen eines normalen Einkaufs privat erwerben.</p>
        </div>

        <div class="agb-section">
          <h4>4. Lieferung</h4>
          <p>(1) Die Lieferung erfolgt monatlich frei Haus an die vom Kunden angegebene Adresse.</p>
          <p>(2) Lieferverz√∂gerungen aufgrund von h√∂herer Gewalt, beh√∂rdlichen Ma√ünahmen oder Lieferengp√§ssen f√ºhren nicht zu Schadensersatzanspr√ºchen des Kunden.</p>
        </div>

        <div class="agb-section">
          <h4>5. Pflichten des Kunden</h4>
          <p>(1) Der Kunde ist verpflichtet, √Ñnderungen seines Pflegegrades, seiner Krankenkasse oder seines Wohnsitzes unverz√ºglich mitzuteilen.</p>
          <p>(2) Der Kunde hat sicherzustellen, dass die gelieferten Produkte ausschlie√ülich zum eigenen Verbrauch im Rahmen der Pflege verwendet werden.</p>
        </div>

        <div class="agb-section">
          <h4>6. Abrechnung und Kosten</h4>
          <p>(1) Die Abrechnung erfolgt direkt mit der zust√§ndigen Pflegekasse bis zum gesetzlichen H√∂chstbetrag von derzeit <strong>42 Euro pro Monat</strong>.</p>
          <p>(2) <strong>Kosten, die √ºber den Betrag von 42 Euro hinausgehen, werden dem Kunden privat in Rechnung gestellt.</strong></p>
          <p>(3) Der Kunde hat auch die M√∂glichkeit, die Pflegebox unabh√§ngig von der Pflegekasse privat zu erwerben.</p>
        </div>

        <div class="agb-section">
          <h4>7. Eigentumsvorbehalt</h4>
          <p>Die gelieferten Produkte bleiben bis zur vollst√§ndigen Bezahlung durch die Pflegekasse oder den Kunden Eigentum des Anbieters.</p>
        </div>

        <div class="agb-section">
          <h4>8. Haftung</h4>
          <p>(1) Der Anbieter haftet nur f√ºr Vorsatz und grobe Fahrl√§ssigkeit.</p>
          <p>(2) F√ºr leichte Fahrl√§ssigkeit haftet der Anbieter nur bei Verletzung wesentlicher Vertragspflichten (Kardinalpflichten), jedoch begrenzt auf den vorhersehbaren, vertragstypischen Schaden.</p>
          <p>(3) Eine Haftung f√ºr unsachgem√§√üe Verwendung der Pflegehilfsmittel ist ausgeschlossen.</p>
        </div>

        <div class="agb-section">
          <h4>9. Laufzeit und K√ºndigung</h4>
          <p>(1) Der Vertrag l√§uft auf unbestimmte Zeit.</p>
          <p>(2) Beide Parteien k√∂nnen den Vertrag jederzeit mit einer Frist von <strong>14 Tagen zum Monatsende</strong> k√ºndigen.</p>
          <p>(3) Das Recht zur au√üerordentlichen K√ºndigung aus wichtigem Grund bleibt unber√ºhrt.</p>
        </div>

        <div class="agb-section">
          <h4>10. Widerrufsrecht f√ºr Privatkunden</h4>
          <p>Sofern der Kunde die Pflegebox unabh√§ngig von der Pflegekasse im Rahmen eines normalen Einkaufs (Privatkauf) erwirbt, gilt folgendes Widerrufsrecht:</p>
          <p><strong>Widerrufsbelehrung</strong></p>
          <p>Sie haben das Recht, binnen 14 Tagen ohne Angabe von Gr√ºnden diesen Vertrag zu widerrufen.</p>
          <p>Die Widerrufsfrist betr√§gt 14 Tage ab dem Tag, an dem Sie oder ein von Ihnen benannter Dritter die Waren in Besitz genommen haben.</p>
          <p>Um Ihr Widerrufsrecht auszu√ºben, m√ºssen Sie uns (Agentur Pflegeteufel, Regentenstra√üe 88, 51063 K√∂ln-M√ºlheim, E-Mail: info@pflegeteufel.de) mittels einer eindeutigen Erkl√§rung (z. B. ein mit der Post versandter Brief, Fax oder E-Mail) √ºber Ihren Entschluss informieren, diesen Vertrag zu widerrufen.</p>
          <p><strong>Folgen des Widerrufs</strong></p>
          <p>Wenn Sie diesen Vertrag widerrufen, haben wir Ihnen alle Zahlungen, die wir von Ihnen erhalten haben, unverz√ºglich und sp√§testens binnen 14 Tagen zur√ºckzuzahlen.</p>
        </div>

        <div class="agb-section">
          <h4>11. Datenschutz</h4>
          <p>(1) Personenbezogene Daten werden ausschlie√ülich zur Vertragsabwicklung, Abrechnung mit der Pflegekasse und Lieferung verwendet.</p>
          <p>(2) Eine Weitergabe erfolgt nur im Rahmen der gesetzlichen Bestimmungen. Weitere Hinweise finden sich in der Datenschutzerkl√§rung des Anbieters.</p>
        </div>

        <div class="agb-section">
          <h4>12. Schlussbestimmungen</h4>
          <p>(1) Es gilt deutsches Recht.</p>
          <p>(2) Gerichtsstand ist ‚Äì soweit zul√§ssig ‚Äì K√∂ln.</p>
          <p>(3) Sollten einzelne Bestimmungen dieser AGB unwirksam sein oder werden, bleibt die Wirksamkeit der √ºbrigen Bestimmungen unber√ºhrt.</p>
        </div>

        <div class="agb-section agb-contact">
          <h4>Kontakt</h4>
          <p>Sollten Sie Fragen haben, wenden Sie sich bitte an:</p>
          <p><strong>Agentur Pflegeteufel</strong><br>
          Regentenstra√üe 88<br>
          51063 K√∂ln-M√ºlheim<br>
          E-Mail: info@pflegeteufel.de</p>
        </div>
      </div>
    </div>
  </div>

  <button
    type="button"
    id="checkout-button"
    class="cart__checkout-button button"
    {% if cart == empty %}
      disabled
    {% endif %}
    disabled
    onclick="proceedToCheckout()"
  >
    {{ 'content.checkout' | t }}
  </button>

  {% if additional_checkout_buttons and settings.show_accelerated_checkout_buttons %}
    <div class="additional-checkout-buttons additional-checkout-buttons--vertical">
      {{ content_for_additional_checkout_buttons }}
    </div>
  {% endif %}
</div>

<style>
/* AGB Expandable Card */
.agb-card {
  background: white;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  margin-bottom: 16px;
  transition: all 0.3s ease;
}

.agb-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  cursor: pointer;
  user-select: none;
  transition: background 0.2s ease;
}

.agb-card-header:hover {
  background: #f8f9fa;
}

.agb-card-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  font-size: 1rem;
  color: #2c3e50;
}

.agb-icon {
  font-size: 1.3rem;
}

.agb-toggle-icon {
  font-size: 1.2rem;
  transition: transform 0.3s ease;
  color: #6c757d;
}

.agb-toggle-icon.open {
  transform: rotate(180deg);
}

.agb-card-content {
  padding: 0 20px 20px;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}

.agb-card-content.open {
  max-height: 600px;
  overflow-y: auto;
}

.agb-scrollable {
  max-height: 550px;
  overflow-y: auto;
  padding-right: 10px;
  margin-bottom: 16px;
}

.agb-scrollable h3 {
  font-size: 1.1rem;
  font-weight: 700;
  color: #2c3e50;
  margin-bottom: 8px;
}

.agb-company-info {
  color: #6c757d;
  font-size: 0.9rem;
  margin-bottom: 16px;
}

.agb-section {
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #f0f0f0;
}

.agb-section:last-child {
  border-bottom: none;
}

.agb-section h4 {
  font-size: 0.95rem;
  font-weight: 700;
  color: #2c3e50;
  margin-bottom: 6px;
}

.agb-section p {
  font-size: 0.85rem;
  color: #555;
  line-height: 1.5;
  margin-bottom: 5px;
}

.agb-checkbox-wrapper {
  background: #ffffff;
  border-radius: 10px;
  padding: 16px;
  border: 2px solid #dee2e6;
  margin-bottom: 16px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: all 0.3s ease;
}

.agb-checkbox-wrapper:has(.agb-checkbox-input:checked) {
  background: #d4edda;
  border-color: #28a745;
  box-shadow: 0 4px 8px rgba(40,167,69,0.15);
}

.agb-accept-label {
  display: flex;
  gap: 10px;
  cursor: pointer;
  align-items: start;
}

.agb-checkbox-input {
  min-width: 18px;
  width: 18px;
  height: 18px;
  cursor: pointer;
  margin-top: 2px;
}

.agb-checkbox-text {
  font-size: 0.9rem;
  line-height: 1.5;
  color: #2c3e50;
}

.agb-checkbox-text a {
  color: #C12624;
  text-decoration: underline;
  font-weight: 600;
}

.agb-checkbox-text a:hover {
  color: #A01F1D;
}

/* Scrollbar */
.agb-scrollable::-webkit-scrollbar {
  width: 6px;
}

.agb-scrollable::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.agb-scrollable::-webkit-scrollbar-thumb {
  background: #C12624;
  border-radius: 3px;
}

.agb-scrollable::-webkit-scrollbar-thumb:hover {
  background: #A01F1D;
}
</style>

<script>
function toggleAGBCard() {
  const content = document.getElementById('agb-card-content');
  const icon = document.getElementById('agb-toggle-icon');

  if (content.style.display === 'none') {
    content.style.display = 'block';
    setTimeout(() => {
      content.classList.add('open');
      icon.classList.add('open');
    }, 10);
  } else {
    content.classList.remove('open');
    icon.classList.remove('open');
    setTimeout(() => {
      content.style.display = 'none';
    }, 300);
  }
}

function toggleCheckoutButton() {
  const checkbox = document.getElementById('agb-checkbox');
  const button = document.getElementById('checkout-button');

  if (checkbox.checked) {
    button.disabled = false;
  } else {
    button.disabled = true;
  }
}

function proceedToCheckout() {
  const form = document.querySelector('form[action="/checkout"]');
  if (form) {
    form.submit();
  } else {
    window.location.href = '/checkout';
  }
}
</script>
